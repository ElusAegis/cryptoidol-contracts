// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import {Test, console2} from "forge-std/Test.sol";
import {CryptoIdol} from "../src/CryptoIdol.sol";
import {CryptoIdolArt} from "../src/CryptoIdolArt.sol";
import {CryptoIdolArtExtra} from "../src/CryptoIdolArtExtra.sol";
import {Halo2Verifier} from "../src/Halo2Verifier.sol";
import {LibString} from "lib/solady/src/utils/LibString.sol";

contract CryptoIdolHarness is CryptoIdol {
    constructor (address owner_, address verifier_, address cryptoIdolArt_)
        CryptoIdol(owner_, verifier_, cryptoIdolArt_)
    {
        maxTokenCount = 1_000;

    }
    function unrestrictedMint() external {
        ++tokenCount;

        if (tokenCount > maxTokenCount) {
            revert CryptoIdol.MINTED_OUT();
        }

        score[tokenCount] = 0;
        minter[tokenCount] = msg.sender;
        mintTime[tokenCount] = block.timestamp;
        _safeMint(msg.sender, tokenCount);
    }
}

abstract contract ERC721TokenReceiver {
    function onERC721Received(address, address, uint256, bytes calldata)
        external
        virtual
        returns (bytes4)
    {
        return ERC721TokenReceiver.onERC721Received.selector;
    }
}


contract CryptoIdolTest is Test, ERC721TokenReceiver {
    using LibString for uint256;

    CryptoIdolHarness public ci;
    Halo2Verifier public civ;
    CryptoIdolArt public cia;
    CryptoIdolArtExtra public ciae;

    function setUp() public {
        civ = new Halo2Verifier();
        ciae = new CryptoIdolArtExtra();
        cia = new CryptoIdolArt(address(ciae));
        ci = new CryptoIdolHarness(address(this), address(civ), address(cia));
    }

    receive() payable external {

    }

    function testSymbolAndName() public {
        assertEq(ci.name(), "CryptoIdol");
        assertEq(ci.symbol(), "IDOLNFT");
    }

    function testIfOwnerCanUpdateVerifier() public {
        Halo2Verifier newCiv = new Halo2Verifier();

        ci.updateVerifier(address(newCiv));

        assertEq(address(ci.verifier()), address(newCiv));

        ci.updateVerifier(address(civ));

        assertEq(address(ci.verifier()), address(civ));
    }

    function testFailIfNonOwnerCanUpdateVerifier() public {
        Halo2Verifier newCiv = new Halo2Verifier();
        vm.prank(address(1));
        ci.updateVerifier(address(newCiv));
    }

    function testRenounceOwnership() public {
        ci.renounceOwnership();
        assertEq(ci.owner(), address(0));
    }

    function testChangeOwnership() public {
        ci.transferOwnership(address(1));
        assertEq(ci.owner(), address(1));
    }

    function testMint() public {
        string[] memory input_proof = new string[](3);
        input_proof[0] = "echo";
        input_proof[1] = "-n";
        input_proof[2] = "0x208d5dd783a4a26ea42688a4a19340a839778d2a51b53fcbdbb00b5a5c03592a057780a9a322fb76a8eb377c5f63ddf51c7249e2a488e98efb4b5f254fbd85a316f43a4526717a77d80d14ca9633ef3e1ed0bb11e7dcb9fba8fb5ce78fcf95bc09d8173b01d382d58dea330a7fe8648fa32fbfcfde071c4c1741e6d82d85447112d75d65873a1769634c27d31cb6fb8c7c067e40767eaabc742a17cb59ab39621ffd4c8bec0139bbbca12a07ccb84ff3e90d131ed5573b3c2760a705f2c250a003951484272c9018a929582f87dac5ab1d1283abedcf1fec3aa00f353cb3651b14ff8c287cd8d2223d38a2677e141cc780420e0a30808c989d00b5754c4556572493c71aad27af6480ca36dd7519b0b94f75b19f1162a4a1135368d77ed3f43325c1079d8721e269af20444b58ca5bc116877120ca1ed24508561fd8be614a672dbaf03756a452bca077f491df286fdaa8e9c41dcf5be4e088f4178672bf97542a26238e0b30c98f823832d417b3e1287fa44fd78ee9c5638e104300541dee953036f9efa777622f6f07aa099a7f786d1a0d87bdf54ea918b5734418fb75281805a4f013c7e87f21d3354746dc373edf8ad2258882419ce5a61baae5af9601f91efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41102685b4eddf3ca504498a8b2a9efe85b04d8194e6d0e6fd1a69c1678813a651ace6119d5abc45b767258578a86d15d8f57072007f21ee449551ec71f12d4760fb0c3d5344181cf895a710808814515fd7fb05b1b6d10b0c99480a638dddcc00031cd49be54c4d5a9a5e9cbdcd3da8eb74e751a5e8ff993956e146e2bb4a56b08e3dca8e3a76fad65869a766dc4d86f5ed2597395cbb6e21de198993a68e423057877697482bdbcf88c08dafe8e4b3c31f2d091bae703fe34b1109bf1b61dba14f18b33261d263665a5aba4f925c59a151cc88c7969bc23dd8d4925724e7d6d0d6d9fdf2000ec1d13c0c2a7d89e2b49536cdbd1b9317253eb7e26a79467f5a3186730165013d8e6c922bcbcf247d3c2e8a48b81611436126c2a8be793558b371ca4dd13dfc13da012ed159f8dbc056225d79f1918074dd32c83e2ea10164521038457fa1258e1e3e6b49716c1fe23391c58cab348a4e33ceb04997b0e5510c70b30f841efd4ea4d2cc8cacf7c0b44b83c78fab0fe5977084707fe687fdb562d1c8f156860ef34af82dfa8852b8a4e280a3eb118db1e7393dd4e34b317df1ef2039e7089d9f284d93884efc20a92483db28309ca5f5608db9dbd9e1ba5f57fcf14fde114c6a02485563c712fbb76c2ab7d7e9666e2ab7169092167ebae2ed0a20744568b59eb51ba4bd3a322448d13da164837f041534c848a0775e678618c6817af2bc631fb0a022c2bf3247097f946e0b17b4f8cf5b869fe127772176e1f601fcef03c97d14634e61f62f8a77e5be9cffe3b936ce4be18f9774081a0a4d445296839e4409af3d85f7f5ada87659112c6c6e1f36c781df0e199c57116d119bf086e0941ddcbfe39ddaa671f5458ad8aa025771060835ec2b3be9d5ba932a0ea296839e4409af3d85f7f5ada87659112c6c6e1f36c781df0e199c57116d119bf086e0941ddcbfe39ddaa671f5458ad8aa025771060835ec2b3be9d5ba932a0ea28b53542da050cbf40d50acb6659db15514427f81f069c343304514b5ef0591d0f751c2d350286538c3e8c29e3322bab6aa412b0875369fd8232c90a47bcaf1320143392aa6d9a21f6895f0db7e0d86b3db387cdfcd2e05360d3dcd22400e22f27f4580ab20b91271bc98b48046f52242a698339adbebc8c0651ae9fb1a3384c1dae1d0236426ef580a2f2c729d7e3a39b9f523e0bc1d3f3673dbb65c506924f1f0468383c47509288632055d1b4ac691f0323fa7c6504367892b29a2bec0321120dcaa8e741a23843c141eb0d4b2c0bbf02310878a97dff33ef2615003f8975240ce1b911a075f9e270b1e3054023ffd1306367ad80a431ab239e0e44044aba2250a67b0a55d1f34b961faa74a4e408dbf9099835f1354c4670d6ba111208c6057bbbee7a1ecf0f7a4ad9b265a7336252f921cc2e933c1010bb3d6f181386bb0b388bddf64eab69a9c7cd0ffc907ba96520cef5cbbf447077647dc61714795a032263cabe794e4d347a9b62436d12cb85cb6b7f79d190b3d05b95aad99b0eee225f8ddec4c4483ee7c2dfa021dfddb6c6d82c6442bb81235d41b9263972279513944c264338555e5016135025b9f5d709e4ba087ef277abbf2ab2d9c94bdb2c1e524c14853d4e31cf1b909b9aa4f289bec432b29cd2619c816de30f4922ec5218391ea6229f80efcf472c653ff2cf528b7e58763b1603c8b122303a0c6cffdf1b9adf4f1711556d0662374bf98aa9bb98d4da4e2fbd86b23a08b8afd708684d0947ea3b1d9a9cd7e61b88e6bc80439b26788e87fb2b010a70c92247373f725309bbe93fd8cfd2a76117cf615e2149cd555c95b1c38aead55fe3c3c5b1fa67190ca645ac7551aceeae21128120f0bc69196d3ca123efb82d92b516afab425cf30f2135864a22eaf8d60b5f37328484d87b0fd4f9b77f12e52fa3015f9c41ff6000d8ce7170476c8f13590ee6fd53c68799d2589de39dbcf3547802fd6bec6d28179338a9afe29098a26e8620185c55ba4047e21dcee5758c827defe01787d8700a3229b231f3b36d4c00b90f73c3dd376f24ca07b3c855c812789d2859b089442ea62825549f37b9b6ed1493b35352f7b4bdb4c3b7320e37f8774f1ea7209d7b11dd85c17179a8243747f17ee1668317dbc4d59137c40e08729ad22bcfe9cd9f230a8b5078af4ec387c2de4664d1c07a6ce1915124d302839905ebc3d700ad7f1a3c79116fbe005d72c4b0f92437a10b5868a9c956e4a6a69a5b678398a80f481fa08c7a16c70098e3d7ec273048f8edb7ca3ccae87dca7a9896dfbcda4c282e1fc1f427a9c276dc73c7bd3dd4474fda6b9af3bd342b19ac6c342e33872a8fe6195f35a51c34b4b9b448add42300cdaa187c17d4f2160880df44d27f9d6787df0c2d1cff1d66d860115886c97c5a15b9b991f3b7c3471f169058838bc73c0a65000000000000000000000000000000000000000000000000000000000000000017b7a9c8b6b67ad93f8fb53c1cee7fc39fb3afc8ef1081fc75d6f84d5361aedc150480ef8f21cc03b885b9753ed1bc92a7bbe1629b5530ada80ed6d7682481f81b8259dcbd5b667fbda1b81889a6ad75bae83e83317b086c6396338cadcd5a4925b314b46e6e7bba2385e61b020d7d2b32102ce1ad5b9ce5ccde48b5c673a36114bde91c2cdf8e484257a35cd30f0be243b54af69bf3089d505dc564bccb367f1de5c075e6bb1586206eb88acc622381a2dd69930ed85ffaa2e53844314a84622e870588acb278dae87efcf08b7076dae1dd9fe172ba5b6b72c7f66354a971a92c76461fd280c61aac5acc6c973ae730735c5528021fe41908f5aad76c40d0740d15ae80b216ece75e743d920ca229a835f14a7a50a067ccf0b4135ff28f14931e447051820a003d757b4dc79f86a0d69ef607643e62227bad75fc292d958e8500000000000000000000000000000000000000000000000000000000000000001c68e4947018e0b7b2bd976512bcf26eedc0368b88c71582aa054d6b748e453c0b79e895383c2e6a49a0de792fc5842a16a7d86a4ee773aa0d44e47188cec446050af92e7bdfe9c93362ea226259843e0c76c50acd37ae90f7907a0f8c5eccf6004bf6731ec59791c8ea07d90dae31da5ad8298f548d1411ff0a07b089285f1600076a16390763e1db220d670c79bd901a7a3c47370efabba7d513351e96ba0409ebf8b11b21bb975c42b235c05a9245f71cba817be21901e2f1437809a346d011299f61aea798466f0598f19fe9ef9ebcefdc89104bbb50759943d9beeddc411270191db769d30f8a1c865462852b9072f15ce8652d65ee8dce3f669fa27b37153e8dbaf5dcb2ed9978616f8ac90d1ae289c64ad7138b52d73433f654e910860f70a2eed5f1ff2f63e704b797778b22dc5b83fb2894f6a2ad3edec40830dc66102c553084f1460d2e45bdc36e9d902e63aa769e60405d726ba4744b897d10650ddaf2cc53c8cf4b604483e70046ed6aadacf6d393779595fb8248a4bbc9699d18a2010cd6950ba08675ddbde45889a2aae17baeeb59fb76982a1e56cefafd180b33d3e0dfc7a929c753a8d00547e73e8f035d41b1b1fa9e2f94d2d64f5c2de7271cf3bb3c378516b5e1f46e0893a59dc83f9620a1f1b645cf99d588386d85942d6b918d6fae9515d27b5431a2b212cb762a35a4dfc652104903796280852ea2262ffc22a4b74fd427ce9594efc20504a92854de85c3b72bbbd73b9ff60ac5571cd0dd9a3c001760bbc22d06286ecb563d185043d1cea6ad04502199437b41d40bbe9c712c991aabc44bb6c2669876735c8f569e442a65725b6aa28ac3a060780a03e58dc2e63df39db99b18946267c17a2246b28a64b19dfec9e2efb9247631024da546edb650fa953a3f967054b266a93a786e20bf4379ddf761ea40f924a00ea2b70ab4bd18a95ec4ab58ee2170be320223714ecc830c06797ea31a5ec3f5290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d03daa71ea64e22ccd7b041695febe10640a223209c23beaa07cd9d9feebf90c32be5a48923b1fd59b90c2fdd63b03d1acfec870b1c85e37de3964a17e5dcd836290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d03daa71ea64e22ccd7b041695febe10640a223209c23beaa07cd9d9feebf90c32be5a48923b1fd59b90c2fdd63b03d1acfec870b1c85e37de3964a17e5dcd836290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d08ffc149e9cc8b5a247e19172b4bbb5eb72e385170ff0b83af5b0efa8e3a6e480b752ce8f07853e4c464afa2346cd8d3d38666ebbd8e4c891a065254914c76f42459e2f5164428e5719e3a67a29c5e2de23e74493164e0843ebcb0845e10179f1b67234391840d50daf1ef3de8a592760ea4c6709e684eaa9568bc82c48bbe2e0042ad8cb45555db6ba79205fd6dc1be6d7fbfd4edce8879e3209673a13d8c3a15769e2d09962923191e8c01eca52e16043109051260004583dd0d4a5296fcc8049d0777c64ecd25f35c98693823754fbd2f69b52b3b2eaefefdb5c4b495df000a0e3d12cad8219a62511a7d62f2b0b920ecbfb63b9da7e92b99eb475e0f5ff01232a2028c342545826281f13b2dea073a7eedf4e27ab59791db2a7505d200e80418e45070e7a177046236fc86ed2c9a0d4f84c03629b33d53f909fc0a2d203603a557e8c04e1b84ae9284178c49bc7964313dc21080a27362857460d2dc0160190c1d0b527b8d655a844c2b53e8f33c2a189012f3e28373b2efcd4b242c31aa01aba1d7bb9d0db92e4aa213252a0abdfb1adf26b638576b594d7c14f0ac1ed82aafbd5537cce9f359a4fb479716acfaae4a908977a181163e516c45e5fe1a550e7563c42aa825dd071f89e7b0fdf71ad75228035b87bcaa0a53e0f3e8487a102221b530ba8ad4db8963f38bfee726050e98237bae85052bca5f9cdbf05802bf";

        bytes memory proof = vm.ffi(input_proof);

        string[] memory input_instance_0 = new string[](3);
        input_instance_0[0] = "echo";
        input_instance_0[1] = "-n";
        input_instance_0[2] = "0x000000000000000000000000000000000000000000000000000000000000000b";

        bytes memory res_instance_0 = vm.ffi(input_instance_0);
        uint256 instance_0 = abi.decode(res_instance_0, (uint256));

        string[] memory input_instance_1 = new string[](3);
        input_instance_1[0] = "echo";
        input_instance_1[1] = "-n";
        input_instance_1[2] = "0x0000000000000000000000000000000000000000000000000000000000000035";

        bytes memory res_instance_1 = vm.ffi(input_instance_1);
        uint256 instance_1 = abi.decode(res_instance_1, (uint256));


        uint256[] memory instances = new uint256[](2);
        instances[0] = instance_0;
        instances[1] = instance_1;

        bytes32 resultHash = keccak256(abi.encode(proof, instances));

        // commit result
        ci.commitResult(resultHash);
        (address committer, uint64 commitTime, uint64 revealTime) = ci.commits(resultHash);

        assertEq(committer, address(this));
        assertEq(commitTime, block.timestamp);
        assertEq(revealTime, 0);


        // mint and balance check
        uint256 myBalance = address(this).balance;
        ci.mint{value: 0.01 ether}(proof, instances);
        assertTrue(address(this).balance <= myBalance - 0.01 ether);
        assertEq(address(ci).balance, 0.01 ether);
        assertEq(ci.balanceOf(address(this)), 1);
        ci.withdraw();
        assertEq(address(ci).balance, 0);
        assertTrue(address(this).balance >= myBalance);

        // output metadata into file
        string memory metadata_output = ci.tokenURI(1);
        vm.writeJson(metadata_output, "./test/metadata/1");
    }

    function testFailMintNoncommitter() public {
        string[] memory input_proof = new string[](3);
        input_proof[0] = "echo";
        input_proof[1] = "-n";
        input_proof[2] = "0x208d5dd783a4a26ea42688a4a19340a839778d2a51b53fcbdbb00b5a5c03592a057780a9a322fb76a8eb377c5f63ddf51c7249e2a488e98efb4b5f254fbd85a316f43a4526717a77d80d14ca9633ef3e1ed0bb11e7dcb9fba8fb5ce78fcf95bc09d8173b01d382d58dea330a7fe8648fa32fbfcfde071c4c1741e6d82d85447112d75d65873a1769634c27d31cb6fb8c7c067e40767eaabc742a17cb59ab39621ffd4c8bec0139bbbca12a07ccb84ff3e90d131ed5573b3c2760a705f2c250a003951484272c9018a929582f87dac5ab1d1283abedcf1fec3aa00f353cb3651b14ff8c287cd8d2223d38a2677e141cc780420e0a30808c989d00b5754c4556572493c71aad27af6480ca36dd7519b0b94f75b19f1162a4a1135368d77ed3f43325c1079d8721e269af20444b58ca5bc116877120ca1ed24508561fd8be614a672dbaf03756a452bca077f491df286fdaa8e9c41dcf5be4e088f4178672bf97542a26238e0b30c98f823832d417b3e1287fa44fd78ee9c5638e104300541dee953036f9efa777622f6f07aa099a7f786d1a0d87bdf54ea918b5734418fb75281805a4f013c7e87f21d3354746dc373edf8ad2258882419ce5a61baae5af9601f91efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41102685b4eddf3ca504498a8b2a9efe85b04d8194e6d0e6fd1a69c1678813a651ace6119d5abc45b767258578a86d15d8f57072007f21ee449551ec71f12d4760fb0c3d5344181cf895a710808814515fd7fb05b1b6d10b0c99480a638dddcc00031cd49be54c4d5a9a5e9cbdcd3da8eb74e751a5e8ff993956e146e2bb4a56b08e3dca8e3a76fad65869a766dc4d86f5ed2597395cbb6e21de198993a68e423057877697482bdbcf88c08dafe8e4b3c31f2d091bae703fe34b1109bf1b61dba14f18b33261d263665a5aba4f925c59a151cc88c7969bc23dd8d4925724e7d6d0d6d9fdf2000ec1d13c0c2a7d89e2b49536cdbd1b9317253eb7e26a79467f5a3186730165013d8e6c922bcbcf247d3c2e8a48b81611436126c2a8be793558b371ca4dd13dfc13da012ed159f8dbc056225d79f1918074dd32c83e2ea10164521038457fa1258e1e3e6b49716c1fe23391c58cab348a4e33ceb04997b0e5510c70b30f841efd4ea4d2cc8cacf7c0b44b83c78fab0fe5977084707fe687fdb562d1c8f156860ef34af82dfa8852b8a4e280a3eb118db1e7393dd4e34b317df1ef2039e7089d9f284d93884efc20a92483db28309ca5f5608db9dbd9e1ba5f57fcf14fde114c6a02485563c712fbb76c2ab7d7e9666e2ab7169092167ebae2ed0a20744568b59eb51ba4bd3a322448d13da164837f041534c848a0775e678618c6817af2bc631fb0a022c2bf3247097f946e0b17b4f8cf5b869fe127772176e1f601fcef03c97d14634e61f62f8a77e5be9cffe3b936ce4be18f9774081a0a4d445296839e4409af3d85f7f5ada87659112c6c6e1f36c781df0e199c57116d119bf086e0941ddcbfe39ddaa671f5458ad8aa025771060835ec2b3be9d5ba932a0ea296839e4409af3d85f7f5ada87659112c6c6e1f36c781df0e199c57116d119bf086e0941ddcbfe39ddaa671f5458ad8aa025771060835ec2b3be9d5ba932a0ea28b53542da050cbf40d50acb6659db15514427f81f069c343304514b5ef0591d0f751c2d350286538c3e8c29e3322bab6aa412b0875369fd8232c90a47bcaf1320143392aa6d9a21f6895f0db7e0d86b3db387cdfcd2e05360d3dcd22400e22f27f4580ab20b91271bc98b48046f52242a698339adbebc8c0651ae9fb1a3384c1dae1d0236426ef580a2f2c729d7e3a39b9f523e0bc1d3f3673dbb65c506924f1f0468383c47509288632055d1b4ac691f0323fa7c6504367892b29a2bec0321120dcaa8e741a23843c141eb0d4b2c0bbf02310878a97dff33ef2615003f8975240ce1b911a075f9e270b1e3054023ffd1306367ad80a431ab239e0e44044aba2250a67b0a55d1f34b961faa74a4e408dbf9099835f1354c4670d6ba111208c6057bbbee7a1ecf0f7a4ad9b265a7336252f921cc2e933c1010bb3d6f181386bb0b388bddf64eab69a9c7cd0ffc907ba96520cef5cbbf447077647dc61714795a032263cabe794e4d347a9b62436d12cb85cb6b7f79d190b3d05b95aad99b0eee225f8ddec4c4483ee7c2dfa021dfddb6c6d82c6442bb81235d41b9263972279513944c264338555e5016135025b9f5d709e4ba087ef277abbf2ab2d9c94bdb2c1e524c14853d4e31cf1b909b9aa4f289bec432b29cd2619c816de30f4922ec5218391ea6229f80efcf472c653ff2cf528b7e58763b1603c8b122303a0c6cffdf1b9adf4f1711556d0662374bf98aa9bb98d4da4e2fbd86b23a08b8afd708684d0947ea3b1d9a9cd7e61b88e6bc80439b26788e87fb2b010a70c92247373f725309bbe93fd8cfd2a76117cf615e2149cd555c95b1c38aead55fe3c3c5b1fa67190ca645ac7551aceeae21128120f0bc69196d3ca123efb82d92b516afab425cf30f2135864a22eaf8d60b5f37328484d87b0fd4f9b77f12e52fa3015f9c41ff6000d8ce7170476c8f13590ee6fd53c68799d2589de39dbcf3547802fd6bec6d28179338a9afe29098a26e8620185c55ba4047e21dcee5758c827defe01787d8700a3229b231f3b36d4c00b90f73c3dd376f24ca07b3c855c812789d2859b089442ea62825549f37b9b6ed1493b35352f7b4bdb4c3b7320e37f8774f1ea7209d7b11dd85c17179a8243747f17ee1668317dbc4d59137c40e08729ad22bcfe9cd9f230a8b5078af4ec387c2de4664d1c07a6ce1915124d302839905ebc3d700ad7f1a3c79116fbe005d72c4b0f92437a10b5868a9c956e4a6a69a5b678398a80f481fa08c7a16c70098e3d7ec273048f8edb7ca3ccae87dca7a9896dfbcda4c282e1fc1f427a9c276dc73c7bd3dd4474fda6b9af3bd342b19ac6c342e33872a8fe6195f35a51c34b4b9b448add42300cdaa187c17d4f2160880df44d27f9d6787df0c2d1cff1d66d860115886c97c5a15b9b991f3b7c3471f169058838bc73c0a65000000000000000000000000000000000000000000000000000000000000000017b7a9c8b6b67ad93f8fb53c1cee7fc39fb3afc8ef1081fc75d6f84d5361aedc150480ef8f21cc03b885b9753ed1bc92a7bbe1629b5530ada80ed6d7682481f81b8259dcbd5b667fbda1b81889a6ad75bae83e83317b086c6396338cadcd5a4925b314b46e6e7bba2385e61b020d7d2b32102ce1ad5b9ce5ccde48b5c673a36114bde91c2cdf8e484257a35cd30f0be243b54af69bf3089d505dc564bccb367f1de5c075e6bb1586206eb88acc622381a2dd69930ed85ffaa2e53844314a84622e870588acb278dae87efcf08b7076dae1dd9fe172ba5b6b72c7f66354a971a92c76461fd280c61aac5acc6c973ae730735c5528021fe41908f5aad76c40d0740d15ae80b216ece75e743d920ca229a835f14a7a50a067ccf0b4135ff28f14931e447051820a003d757b4dc79f86a0d69ef607643e62227bad75fc292d958e8500000000000000000000000000000000000000000000000000000000000000001c68e4947018e0b7b2bd976512bcf26eedc0368b88c71582aa054d6b748e453c0b79e895383c2e6a49a0de792fc5842a16a7d86a4ee773aa0d44e47188cec446050af92e7bdfe9c93362ea226259843e0c76c50acd37ae90f7907a0f8c5eccf6004bf6731ec59791c8ea07d90dae31da5ad8298f548d1411ff0a07b089285f1600076a16390763e1db220d670c79bd901a7a3c47370efabba7d513351e96ba0409ebf8b11b21bb975c42b235c05a9245f71cba817be21901e2f1437809a346d011299f61aea798466f0598f19fe9ef9ebcefdc89104bbb50759943d9beeddc411270191db769d30f8a1c865462852b9072f15ce8652d65ee8dce3f669fa27b37153e8dbaf5dcb2ed9978616f8ac90d1ae289c64ad7138b52d73433f654e910860f70a2eed5f1ff2f63e704b797778b22dc5b83fb2894f6a2ad3edec40830dc66102c553084f1460d2e45bdc36e9d902e63aa769e60405d726ba4744b897d10650ddaf2cc53c8cf4b604483e70046ed6aadacf6d393779595fb8248a4bbc9699d18a2010cd6950ba08675ddbde45889a2aae17baeeb59fb76982a1e56cefafd180b33d3e0dfc7a929c753a8d00547e73e8f035d41b1b1fa9e2f94d2d64f5c2de7271cf3bb3c378516b5e1f46e0893a59dc83f9620a1f1b645cf99d588386d85942d6b918d6fae9515d27b5431a2b212cb762a35a4dfc652104903796280852ea2262ffc22a4b74fd427ce9594efc20504a92854de85c3b72bbbd73b9ff60ac5571cd0dd9a3c001760bbc22d06286ecb563d185043d1cea6ad04502199437b41d40bbe9c712c991aabc44bb6c2669876735c8f569e442a65725b6aa28ac3a060780a03e58dc2e63df39db99b18946267c17a2246b28a64b19dfec9e2efb9247631024da546edb650fa953a3f967054b266a93a786e20bf4379ddf761ea40f924a00ea2b70ab4bd18a95ec4ab58ee2170be320223714ecc830c06797ea31a5ec3f5290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d03daa71ea64e22ccd7b041695febe10640a223209c23beaa07cd9d9feebf90c32be5a48923b1fd59b90c2fdd63b03d1acfec870b1c85e37de3964a17e5dcd836290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d03daa71ea64e22ccd7b041695febe10640a223209c23beaa07cd9d9feebf90c32be5a48923b1fd59b90c2fdd63b03d1acfec870b1c85e37de3964a17e5dcd836290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d08ffc149e9cc8b5a247e19172b4bbb5eb72e385170ff0b83af5b0efa8e3a6e480b752ce8f07853e4c464afa2346cd8d3d38666ebbd8e4c891a065254914c76f42459e2f5164428e5719e3a67a29c5e2de23e74493164e0843ebcb0845e10179f1b67234391840d50daf1ef3de8a592760ea4c6709e684eaa9568bc82c48bbe2e0042ad8cb45555db6ba79205fd6dc1be6d7fbfd4edce8879e3209673a13d8c3a15769e2d09962923191e8c01eca52e16043109051260004583dd0d4a5296fcc8049d0777c64ecd25f35c98693823754fbd2f69b52b3b2eaefefdb5c4b495df000a0e3d12cad8219a62511a7d62f2b0b920ecbfb63b9da7e92b99eb475e0f5ff01232a2028c342545826281f13b2dea073a7eedf4e27ab59791db2a7505d200e80418e45070e7a177046236fc86ed2c9a0d4f84c03629b33d53f909fc0a2d203603a557e8c04e1b84ae9284178c49bc7964313dc21080a27362857460d2dc0160190c1d0b527b8d655a844c2b53e8f33c2a189012f3e28373b2efcd4b242c31aa01aba1d7bb9d0db92e4aa213252a0abdfb1adf26b638576b594d7c14f0ac1ed82aafbd5537cce9f359a4fb479716acfaae4a908977a181163e516c45e5fe1a550e7563c42aa825dd071f89e7b0fdf71ad75228035b87bcaa0a53e0f3e8487a102221b530ba8ad4db8963f38bfee726050e98237bae85052bca5f9cdbf05802bf";

        bytes memory proof = vm.ffi(input_proof);

        string[] memory input_instance_0 = new string[](3);
        input_instance_0[0] = "echo";
        input_instance_0[1] = "-n";
        input_instance_0[2] = "0x000000000000000000000000000000000000000000000000000000000000000b";

        bytes memory res_instance_0 = vm.ffi(input_instance_0);
        uint256 instance_0 = abi.decode(res_instance_0, (uint256));

        string[] memory input_instance_1 = new string[](3);
        input_instance_1[0] = "echo";
        input_instance_1[1] = "-n";
        input_instance_1[2] = "0x0000000000000000000000000000000000000000000000000000000000000035";

        bytes memory res_instance_1 = vm.ffi(input_instance_1);
        uint256 instance_1 = abi.decode(res_instance_1, (uint256));


        uint256[] memory instances = new uint256[](2);
        instances[0] = instance_0;
        instances[1] = instance_1;

        bytes32 resultHash = keccak256(abi.encode(proof, instances));

        // commit result
        ci.commitResult(resultHash);
        (address committer, uint64 commitTime, uint64 revealTime) = ci.commits(resultHash);

        assertEq(committer, address(this));
        assertEq(commitTime, block.timestamp);
        assertEq(revealTime, 0);


        // mint and balance check
        vm.prank(address(1));
        ci.mint{value: 0.01 ether}(proof, instances);
    }


    function testFailAlreadyCommitResult() public {
        string[] memory input_proof = new string[](3);
        input_proof[0] = "echo";
        input_proof[1] = "-n";
        input_proof[2] = "0x208d5dd783a4a26ea42688a4a19340a839778d2a51b53fcbdbb00b5a5c03592a057780a9a322fb76a8eb377c5f63ddf51c7249e2a488e98efb4b5f254fbd85a316f43a4526717a77d80d14ca9633ef3e1ed0bb11e7dcb9fba8fb5ce78fcf95bc09d8173b01d382d58dea330a7fe8648fa32fbfcfde071c4c1741e6d82d85447112d75d65873a1769634c27d31cb6fb8c7c067e40767eaabc742a17cb59ab39621ffd4c8bec0139bbbca12a07ccb84ff3e90d131ed5573b3c2760a705f2c250a003951484272c9018a929582f87dac5ab1d1283abedcf1fec3aa00f353cb3651b14ff8c287cd8d2223d38a2677e141cc780420e0a30808c989d00b5754c4556572493c71aad27af6480ca36dd7519b0b94f75b19f1162a4a1135368d77ed3f43325c1079d8721e269af20444b58ca5bc116877120ca1ed24508561fd8be614a672dbaf03756a452bca077f491df286fdaa8e9c41dcf5be4e088f4178672bf97542a26238e0b30c98f823832d417b3e1287fa44fd78ee9c5638e104300541dee953036f9efa777622f6f07aa099a7f786d1a0d87bdf54ea918b5734418fb75281805a4f013c7e87f21d3354746dc373edf8ad2258882419ce5a61baae5af9601f91efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41102685b4eddf3ca504498a8b2a9efe85b04d8194e6d0e6fd1a69c1678813a651ace6119d5abc45b767258578a86d15d8f57072007f21ee449551ec71f12d4760fb0c3d5344181cf895a710808814515fd7fb05b1b6d10b0c99480a638dddcc00031cd49be54c4d5a9a5e9cbdcd3da8eb74e751a5e8ff993956e146e2bb4a56b08e3dca8e3a76fad65869a766dc4d86f5ed2597395cbb6e21de198993a68e423057877697482bdbcf88c08dafe8e4b3c31f2d091bae703fe34b1109bf1b61dba14f18b33261d263665a5aba4f925c59a151cc88c7969bc23dd8d4925724e7d6d0d6d9fdf2000ec1d13c0c2a7d89e2b49536cdbd1b9317253eb7e26a79467f5a3186730165013d8e6c922bcbcf247d3c2e8a48b81611436126c2a8be793558b371ca4dd13dfc13da012ed159f8dbc056225d79f1918074dd32c83e2ea10164521038457fa1258e1e3e6b49716c1fe23391c58cab348a4e33ceb04997b0e5510c70b30f841efd4ea4d2cc8cacf7c0b44b83c78fab0fe5977084707fe687fdb562d1c8f156860ef34af82dfa8852b8a4e280a3eb118db1e7393dd4e34b317df1ef2039e7089d9f284d93884efc20a92483db28309ca5f5608db9dbd9e1ba5f57fcf14fde114c6a02485563c712fbb76c2ab7d7e9666e2ab7169092167ebae2ed0a20744568b59eb51ba4bd3a322448d13da164837f041534c848a0775e678618c6817af2bc631fb0a022c2bf3247097f946e0b17b4f8cf5b869fe127772176e1f601fcef03c97d14634e61f62f8a77e5be9cffe3b936ce4be18f9774081a0a4d445296839e4409af3d85f7f5ada87659112c6c6e1f36c781df0e199c57116d119bf086e0941ddcbfe39ddaa671f5458ad8aa025771060835ec2b3be9d5ba932a0ea296839e4409af3d85f7f5ada87659112c6c6e1f36c781df0e199c57116d119bf086e0941ddcbfe39ddaa671f5458ad8aa025771060835ec2b3be9d5ba932a0ea28b53542da050cbf40d50acb6659db15514427f81f069c343304514b5ef0591d0f751c2d350286538c3e8c29e3322bab6aa412b0875369fd8232c90a47bcaf1320143392aa6d9a21f6895f0db7e0d86b3db387cdfcd2e05360d3dcd22400e22f27f4580ab20b91271bc98b48046f52242a698339adbebc8c0651ae9fb1a3384c1dae1d0236426ef580a2f2c729d7e3a39b9f523e0bc1d3f3673dbb65c506924f1f0468383c47509288632055d1b4ac691f0323fa7c6504367892b29a2bec0321120dcaa8e741a23843c141eb0d4b2c0bbf02310878a97dff33ef2615003f8975240ce1b911a075f9e270b1e3054023ffd1306367ad80a431ab239e0e44044aba2250a67b0a55d1f34b961faa74a4e408dbf9099835f1354c4670d6ba111208c6057bbbee7a1ecf0f7a4ad9b265a7336252f921cc2e933c1010bb3d6f181386bb0b388bddf64eab69a9c7cd0ffc907ba96520cef5cbbf447077647dc61714795a032263cabe794e4d347a9b62436d12cb85cb6b7f79d190b3d05b95aad99b0eee225f8ddec4c4483ee7c2dfa021dfddb6c6d82c6442bb81235d41b9263972279513944c264338555e5016135025b9f5d709e4ba087ef277abbf2ab2d9c94bdb2c1e524c14853d4e31cf1b909b9aa4f289bec432b29cd2619c816de30f4922ec5218391ea6229f80efcf472c653ff2cf528b7e58763b1603c8b122303a0c6cffdf1b9adf4f1711556d0662374bf98aa9bb98d4da4e2fbd86b23a08b8afd708684d0947ea3b1d9a9cd7e61b88e6bc80439b26788e87fb2b010a70c92247373f725309bbe93fd8cfd2a76117cf615e2149cd555c95b1c38aead55fe3c3c5b1fa67190ca645ac7551aceeae21128120f0bc69196d3ca123efb82d92b516afab425cf30f2135864a22eaf8d60b5f37328484d87b0fd4f9b77f12e52fa3015f9c41ff6000d8ce7170476c8f13590ee6fd53c68799d2589de39dbcf3547802fd6bec6d28179338a9afe29098a26e8620185c55ba4047e21dcee5758c827defe01787d8700a3229b231f3b36d4c00b90f73c3dd376f24ca07b3c855c812789d2859b089442ea62825549f37b9b6ed1493b35352f7b4bdb4c3b7320e37f8774f1ea7209d7b11dd85c17179a8243747f17ee1668317dbc4d59137c40e08729ad22bcfe9cd9f230a8b5078af4ec387c2de4664d1c07a6ce1915124d302839905ebc3d700ad7f1a3c79116fbe005d72c4b0f92437a10b5868a9c956e4a6a69a5b678398a80f481fa08c7a16c70098e3d7ec273048f8edb7ca3ccae87dca7a9896dfbcda4c282e1fc1f427a9c276dc73c7bd3dd4474fda6b9af3bd342b19ac6c342e33872a8fe6195f35a51c34b4b9b448add42300cdaa187c17d4f2160880df44d27f9d6787df0c2d1cff1d66d860115886c97c5a15b9b991f3b7c3471f169058838bc73c0a65000000000000000000000000000000000000000000000000000000000000000017b7a9c8b6b67ad93f8fb53c1cee7fc39fb3afc8ef1081fc75d6f84d5361aedc150480ef8f21cc03b885b9753ed1bc92a7bbe1629b5530ada80ed6d7682481f81b8259dcbd5b667fbda1b81889a6ad75bae83e83317b086c6396338cadcd5a4925b314b46e6e7bba2385e61b020d7d2b32102ce1ad5b9ce5ccde48b5c673a36114bde91c2cdf8e484257a35cd30f0be243b54af69bf3089d505dc564bccb367f1de5c075e6bb1586206eb88acc622381a2dd69930ed85ffaa2e53844314a84622e870588acb278dae87efcf08b7076dae1dd9fe172ba5b6b72c7f66354a971a92c76461fd280c61aac5acc6c973ae730735c5528021fe41908f5aad76c40d0740d15ae80b216ece75e743d920ca229a835f14a7a50a067ccf0b4135ff28f14931e447051820a003d757b4dc79f86a0d69ef607643e62227bad75fc292d958e8500000000000000000000000000000000000000000000000000000000000000001c68e4947018e0b7b2bd976512bcf26eedc0368b88c71582aa054d6b748e453c0b79e895383c2e6a49a0de792fc5842a16a7d86a4ee773aa0d44e47188cec446050af92e7bdfe9c93362ea226259843e0c76c50acd37ae90f7907a0f8c5eccf6004bf6731ec59791c8ea07d90dae31da5ad8298f548d1411ff0a07b089285f1600076a16390763e1db220d670c79bd901a7a3c47370efabba7d513351e96ba0409ebf8b11b21bb975c42b235c05a9245f71cba817be21901e2f1437809a346d011299f61aea798466f0598f19fe9ef9ebcefdc89104bbb50759943d9beeddc411270191db769d30f8a1c865462852b9072f15ce8652d65ee8dce3f669fa27b37153e8dbaf5dcb2ed9978616f8ac90d1ae289c64ad7138b52d73433f654e910860f70a2eed5f1ff2f63e704b797778b22dc5b83fb2894f6a2ad3edec40830dc66102c553084f1460d2e45bdc36e9d902e63aa769e60405d726ba4744b897d10650ddaf2cc53c8cf4b604483e70046ed6aadacf6d393779595fb8248a4bbc9699d18a2010cd6950ba08675ddbde45889a2aae17baeeb59fb76982a1e56cefafd180b33d3e0dfc7a929c753a8d00547e73e8f035d41b1b1fa9e2f94d2d64f5c2de7271cf3bb3c378516b5e1f46e0893a59dc83f9620a1f1b645cf99d588386d85942d6b918d6fae9515d27b5431a2b212cb762a35a4dfc652104903796280852ea2262ffc22a4b74fd427ce9594efc20504a92854de85c3b72bbbd73b9ff60ac5571cd0dd9a3c001760bbc22d06286ecb563d185043d1cea6ad04502199437b41d40bbe9c712c991aabc44bb6c2669876735c8f569e442a65725b6aa28ac3a060780a03e58dc2e63df39db99b18946267c17a2246b28a64b19dfec9e2efb9247631024da546edb650fa953a3f967054b266a93a786e20bf4379ddf761ea40f924a00ea2b70ab4bd18a95ec4ab58ee2170be320223714ecc830c06797ea31a5ec3f5290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d03daa71ea64e22ccd7b041695febe10640a223209c23beaa07cd9d9feebf90c32be5a48923b1fd59b90c2fdd63b03d1acfec870b1c85e37de3964a17e5dcd836290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d03daa71ea64e22ccd7b041695febe10640a223209c23beaa07cd9d9feebf90c32be5a48923b1fd59b90c2fdd63b03d1acfec870b1c85e37de3964a17e5dcd836290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d08ffc149e9cc8b5a247e19172b4bbb5eb72e385170ff0b83af5b0efa8e3a6e480b752ce8f07853e4c464afa2346cd8d3d38666ebbd8e4c891a065254914c76f42459e2f5164428e5719e3a67a29c5e2de23e74493164e0843ebcb0845e10179f1b67234391840d50daf1ef3de8a592760ea4c6709e684eaa9568bc82c48bbe2e0042ad8cb45555db6ba79205fd6dc1be6d7fbfd4edce8879e3209673a13d8c3a15769e2d09962923191e8c01eca52e16043109051260004583dd0d4a5296fcc8049d0777c64ecd25f35c98693823754fbd2f69b52b3b2eaefefdb5c4b495df000a0e3d12cad8219a62511a7d62f2b0b920ecbfb63b9da7e92b99eb475e0f5ff01232a2028c342545826281f13b2dea073a7eedf4e27ab59791db2a7505d200e80418e45070e7a177046236fc86ed2c9a0d4f84c03629b33d53f909fc0a2d203603a557e8c04e1b84ae9284178c49bc7964313dc21080a27362857460d2dc0160190c1d0b527b8d655a844c2b53e8f33c2a189012f3e28373b2efcd4b242c31aa01aba1d7bb9d0db92e4aa213252a0abdfb1adf26b638576b594d7c14f0ac1ed82aafbd5537cce9f359a4fb479716acfaae4a908977a181163e516c45e5fe1a550e7563c42aa825dd071f89e7b0fdf71ad75228035b87bcaa0a53e0f3e8487a102221b530ba8ad4db8963f38bfee726050e98237bae85052bca5f9cdbf05802bf";

        bytes memory proof = vm.ffi(input_proof);

        string[] memory input_instance_0 = new string[](3);
        input_instance_0[0] = "echo";
        input_instance_0[1] = "-n";
        input_instance_0[2] = "0x000000000000000000000000000000000000000000000000000000000000000b";

        bytes memory res_instance_0 = vm.ffi(input_instance_0);
        uint256 instance_0 = abi.decode(res_instance_0, (uint256));

        string[] memory input_instance_1 = new string[](3);
        input_instance_1[0] = "echo";
        input_instance_1[1] = "-n";
        input_instance_1[2] = "0x0000000000000000000000000000000000000000000000000000000000000035";

        bytes memory res_instance_1 = vm.ffi(input_instance_1);
        uint256 instance_1 = abi.decode(res_instance_1, (uint256));


        uint256[] memory instances = new uint256[](2);
        instances[0] = instance_0;
        instances[1] = instance_1;

        bytes32 resultHash = keccak256(abi.encode(proof, instances));

        // commit result
        ci.commitResult(resultHash);
        ci.commitResult(resultHash);
    }

    function testFailMintTwice() public {
        string[] memory input_proof = new string[](3);
        input_proof[0] = "echo";
        input_proof[1] = "-n";
        input_proof[2] = "0x208d5dd783a4a26ea42688a4a19340a839778d2a51b53fcbdbb00b5a5c03592a057780a9a322fb76a8eb377c5f63ddf51c7249e2a488e98efb4b5f254fbd85a316f43a4526717a77d80d14ca9633ef3e1ed0bb11e7dcb9fba8fb5ce78fcf95bc09d8173b01d382d58dea330a7fe8648fa32fbfcfde071c4c1741e6d82d85447112d75d65873a1769634c27d31cb6fb8c7c067e40767eaabc742a17cb59ab39621ffd4c8bec0139bbbca12a07ccb84ff3e90d131ed5573b3c2760a705f2c250a003951484272c9018a929582f87dac5ab1d1283abedcf1fec3aa00f353cb3651b14ff8c287cd8d2223d38a2677e141cc780420e0a30808c989d00b5754c4556572493c71aad27af6480ca36dd7519b0b94f75b19f1162a4a1135368d77ed3f43325c1079d8721e269af20444b58ca5bc116877120ca1ed24508561fd8be614a672dbaf03756a452bca077f491df286fdaa8e9c41dcf5be4e088f4178672bf97542a26238e0b30c98f823832d417b3e1287fa44fd78ee9c5638e104300541dee953036f9efa777622f6f07aa099a7f786d1a0d87bdf54ea918b5734418fb75281805a4f013c7e87f21d3354746dc373edf8ad2258882419ce5a61baae5af9601f91efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41efe61e76ba18f81867e524093084dce151b53f82c4f931753d3978cbdaa35191f31d46738d333142c225f5325273b6a22ead726b44ee175b2b0ddd45072efc41102685b4eddf3ca504498a8b2a9efe85b04d8194e6d0e6fd1a69c1678813a651ace6119d5abc45b767258578a86d15d8f57072007f21ee449551ec71f12d4760fb0c3d5344181cf895a710808814515fd7fb05b1b6d10b0c99480a638dddcc00031cd49be54c4d5a9a5e9cbdcd3da8eb74e751a5e8ff993956e146e2bb4a56b08e3dca8e3a76fad65869a766dc4d86f5ed2597395cbb6e21de198993a68e423057877697482bdbcf88c08dafe8e4b3c31f2d091bae703fe34b1109bf1b61dba14f18b33261d263665a5aba4f925c59a151cc88c7969bc23dd8d4925724e7d6d0d6d9fdf2000ec1d13c0c2a7d89e2b49536cdbd1b9317253eb7e26a79467f5a3186730165013d8e6c922bcbcf247d3c2e8a48b81611436126c2a8be793558b371ca4dd13dfc13da012ed159f8dbc056225d79f1918074dd32c83e2ea10164521038457fa1258e1e3e6b49716c1fe23391c58cab348a4e33ceb04997b0e5510c70b30f841efd4ea4d2cc8cacf7c0b44b83c78fab0fe5977084707fe687fdb562d1c8f156860ef34af82dfa8852b8a4e280a3eb118db1e7393dd4e34b317df1ef2039e7089d9f284d93884efc20a92483db28309ca5f5608db9dbd9e1ba5f57fcf14fde114c6a02485563c712fbb76c2ab7d7e9666e2ab7169092167ebae2ed0a20744568b59eb51ba4bd3a322448d13da164837f041534c848a0775e678618c6817af2bc631fb0a022c2bf3247097f946e0b17b4f8cf5b869fe127772176e1f601fcef03c97d14634e61f62f8a77e5be9cffe3b936ce4be18f9774081a0a4d445296839e4409af3d85f7f5ada87659112c6c6e1f36c781df0e199c57116d119bf086e0941ddcbfe39ddaa671f5458ad8aa025771060835ec2b3be9d5ba932a0ea296839e4409af3d85f7f5ada87659112c6c6e1f36c781df0e199c57116d119bf086e0941ddcbfe39ddaa671f5458ad8aa025771060835ec2b3be9d5ba932a0ea28b53542da050cbf40d50acb6659db15514427f81f069c343304514b5ef0591d0f751c2d350286538c3e8c29e3322bab6aa412b0875369fd8232c90a47bcaf1320143392aa6d9a21f6895f0db7e0d86b3db387cdfcd2e05360d3dcd22400e22f27f4580ab20b91271bc98b48046f52242a698339adbebc8c0651ae9fb1a3384c1dae1d0236426ef580a2f2c729d7e3a39b9f523e0bc1d3f3673dbb65c506924f1f0468383c47509288632055d1b4ac691f0323fa7c6504367892b29a2bec0321120dcaa8e741a23843c141eb0d4b2c0bbf02310878a97dff33ef2615003f8975240ce1b911a075f9e270b1e3054023ffd1306367ad80a431ab239e0e44044aba2250a67b0a55d1f34b961faa74a4e408dbf9099835f1354c4670d6ba111208c6057bbbee7a1ecf0f7a4ad9b265a7336252f921cc2e933c1010bb3d6f181386bb0b388bddf64eab69a9c7cd0ffc907ba96520cef5cbbf447077647dc61714795a032263cabe794e4d347a9b62436d12cb85cb6b7f79d190b3d05b95aad99b0eee225f8ddec4c4483ee7c2dfa021dfddb6c6d82c6442bb81235d41b9263972279513944c264338555e5016135025b9f5d709e4ba087ef277abbf2ab2d9c94bdb2c1e524c14853d4e31cf1b909b9aa4f289bec432b29cd2619c816de30f4922ec5218391ea6229f80efcf472c653ff2cf528b7e58763b1603c8b122303a0c6cffdf1b9adf4f1711556d0662374bf98aa9bb98d4da4e2fbd86b23a08b8afd708684d0947ea3b1d9a9cd7e61b88e6bc80439b26788e87fb2b010a70c92247373f725309bbe93fd8cfd2a76117cf615e2149cd555c95b1c38aead55fe3c3c5b1fa67190ca645ac7551aceeae21128120f0bc69196d3ca123efb82d92b516afab425cf30f2135864a22eaf8d60b5f37328484d87b0fd4f9b77f12e52fa3015f9c41ff6000d8ce7170476c8f13590ee6fd53c68799d2589de39dbcf3547802fd6bec6d28179338a9afe29098a26e8620185c55ba4047e21dcee5758c827defe01787d8700a3229b231f3b36d4c00b90f73c3dd376f24ca07b3c855c812789d2859b089442ea62825549f37b9b6ed1493b35352f7b4bdb4c3b7320e37f8774f1ea7209d7b11dd85c17179a8243747f17ee1668317dbc4d59137c40e08729ad22bcfe9cd9f230a8b5078af4ec387c2de4664d1c07a6ce1915124d302839905ebc3d700ad7f1a3c79116fbe005d72c4b0f92437a10b5868a9c956e4a6a69a5b678398a80f481fa08c7a16c70098e3d7ec273048f8edb7ca3ccae87dca7a9896dfbcda4c282e1fc1f427a9c276dc73c7bd3dd4474fda6b9af3bd342b19ac6c342e33872a8fe6195f35a51c34b4b9b448add42300cdaa187c17d4f2160880df44d27f9d6787df0c2d1cff1d66d860115886c97c5a15b9b991f3b7c3471f169058838bc73c0a65000000000000000000000000000000000000000000000000000000000000000017b7a9c8b6b67ad93f8fb53c1cee7fc39fb3afc8ef1081fc75d6f84d5361aedc150480ef8f21cc03b885b9753ed1bc92a7bbe1629b5530ada80ed6d7682481f81b8259dcbd5b667fbda1b81889a6ad75bae83e83317b086c6396338cadcd5a4925b314b46e6e7bba2385e61b020d7d2b32102ce1ad5b9ce5ccde48b5c673a36114bde91c2cdf8e484257a35cd30f0be243b54af69bf3089d505dc564bccb367f1de5c075e6bb1586206eb88acc622381a2dd69930ed85ffaa2e53844314a84622e870588acb278dae87efcf08b7076dae1dd9fe172ba5b6b72c7f66354a971a92c76461fd280c61aac5acc6c973ae730735c5528021fe41908f5aad76c40d0740d15ae80b216ece75e743d920ca229a835f14a7a50a067ccf0b4135ff28f14931e447051820a003d757b4dc79f86a0d69ef607643e62227bad75fc292d958e8500000000000000000000000000000000000000000000000000000000000000001c68e4947018e0b7b2bd976512bcf26eedc0368b88c71582aa054d6b748e453c0b79e895383c2e6a49a0de792fc5842a16a7d86a4ee773aa0d44e47188cec446050af92e7bdfe9c93362ea226259843e0c76c50acd37ae90f7907a0f8c5eccf6004bf6731ec59791c8ea07d90dae31da5ad8298f548d1411ff0a07b089285f1600076a16390763e1db220d670c79bd901a7a3c47370efabba7d513351e96ba0409ebf8b11b21bb975c42b235c05a9245f71cba817be21901e2f1437809a346d011299f61aea798466f0598f19fe9ef9ebcefdc89104bbb50759943d9beeddc411270191db769d30f8a1c865462852b9072f15ce8652d65ee8dce3f669fa27b37153e8dbaf5dcb2ed9978616f8ac90d1ae289c64ad7138b52d73433f654e910860f70a2eed5f1ff2f63e704b797778b22dc5b83fb2894f6a2ad3edec40830dc66102c553084f1460d2e45bdc36e9d902e63aa769e60405d726ba4744b897d10650ddaf2cc53c8cf4b604483e70046ed6aadacf6d393779595fb8248a4bbc9699d18a2010cd6950ba08675ddbde45889a2aae17baeeb59fb76982a1e56cefafd180b33d3e0dfc7a929c753a8d00547e73e8f035d41b1b1fa9e2f94d2d64f5c2de7271cf3bb3c378516b5e1f46e0893a59dc83f9620a1f1b645cf99d588386d85942d6b918d6fae9515d27b5431a2b212cb762a35a4dfc652104903796280852ea2262ffc22a4b74fd427ce9594efc20504a92854de85c3b72bbbd73b9ff60ac5571cd0dd9a3c001760bbc22d06286ecb563d185043d1cea6ad04502199437b41d40bbe9c712c991aabc44bb6c2669876735c8f569e442a65725b6aa28ac3a060780a03e58dc2e63df39db99b18946267c17a2246b28a64b19dfec9e2efb9247631024da546edb650fa953a3f967054b266a93a786e20bf4379ddf761ea40f924a00ea2b70ab4bd18a95ec4ab58ee2170be320223714ecc830c06797ea31a5ec3f5290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d03daa71ea64e22ccd7b041695febe10640a223209c23beaa07cd9d9feebf90c32be5a48923b1fd59b90c2fdd63b03d1acfec870b1c85e37de3964a17e5dcd836290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d03daa71ea64e22ccd7b041695febe10640a223209c23beaa07cd9d9feebf90c32be5a48923b1fd59b90c2fdd63b03d1acfec870b1c85e37de3964a17e5dcd836290e0c637fc8495f139b1f03b48ad60dc83e48254f688e46b0e362776320b09d08ffc149e9cc8b5a247e19172b4bbb5eb72e385170ff0b83af5b0efa8e3a6e480b752ce8f07853e4c464afa2346cd8d3d38666ebbd8e4c891a065254914c76f42459e2f5164428e5719e3a67a29c5e2de23e74493164e0843ebcb0845e10179f1b67234391840d50daf1ef3de8a592760ea4c6709e684eaa9568bc82c48bbe2e0042ad8cb45555db6ba79205fd6dc1be6d7fbfd4edce8879e3209673a13d8c3a15769e2d09962923191e8c01eca52e16043109051260004583dd0d4a5296fcc8049d0777c64ecd25f35c98693823754fbd2f69b52b3b2eaefefdb5c4b495df000a0e3d12cad8219a62511a7d62f2b0b920ecbfb63b9da7e92b99eb475e0f5ff01232a2028c342545826281f13b2dea073a7eedf4e27ab59791db2a7505d200e80418e45070e7a177046236fc86ed2c9a0d4f84c03629b33d53f909fc0a2d203603a557e8c04e1b84ae9284178c49bc7964313dc21080a27362857460d2dc0160190c1d0b527b8d655a844c2b53e8f33c2a189012f3e28373b2efcd4b242c31aa01aba1d7bb9d0db92e4aa213252a0abdfb1adf26b638576b594d7c14f0ac1ed82aafbd5537cce9f359a4fb479716acfaae4a908977a181163e516c45e5fe1a550e7563c42aa825dd071f89e7b0fdf71ad75228035b87bcaa0a53e0f3e8487a102221b530ba8ad4db8963f38bfee726050e98237bae85052bca5f9cdbf05802bf";

        bytes memory proof = vm.ffi(input_proof);

        string[] memory input_instance_0 = new string[](3);
        input_instance_0[0] = "echo";
        input_instance_0[1] = "-n";
        input_instance_0[2] = "0x000000000000000000000000000000000000000000000000000000000000000b";

        bytes memory res_instance_0 = vm.ffi(input_instance_0);
        uint256 instance_0 = abi.decode(res_instance_0, (uint256));

        string[] memory input_instance_1 = new string[](3);
        input_instance_1[0] = "echo";
        input_instance_1[1] = "-n";
        input_instance_1[2] = "0x0000000000000000000000000000000000000000000000000000000000000035";

        bytes memory res_instance_1 = vm.ffi(input_instance_1);
        uint256 instance_1 = abi.decode(res_instance_1, (uint256));


        uint256[] memory instances = new uint256[](2);
        instances[0] = instance_0;
        instances[1] = instance_1;

        bytes32 resultHash = keccak256(abi.encode(proof, instances));

        // commit result
        ci.commitResult(resultHash);
        (address committer, uint64 commitTime, uint64 revealTime) = ci.commits(resultHash);

        assertEq(committer, address(this));
        assertEq(commitTime, block.timestamp);
        assertEq(revealTime, 0);


        // mint and balance check
        ci.mint{value: 0.01 ether}(proof, instances);
        ci.mint{value: 0.01 ether}(proof, instances);
    }

    function testFailMintNoMoney() public {
        string[] memory input_proof = new string[](3);
        input_proof[0] = "echo";
        input_proof[1] = "-n";
        input_proof[2] = "0x127dfd437c3bb2d7d35ce8eb6bdf58d8550cab28810fa73dd54a5732ec7f122028dd6d0e677375415a2372130a0ed642255d6c578c70613482da0bb72fbfe6f90754f8fc4b495f69a66e076b6dec4ce3cde78937cdce9807969281a294464c831b7fc0d92248fb651a9d00fcf74442aa79fbf143cc5d70a60007c9511ca0f4bc2dae61c30a70130f9a2fbd2a936b9aeca7b58c8f73a13fd349557d713c072e61198e07ee161d96b9cddf2442b9827549b6f71cc74fcd5bfbf9c5181a8816d4f506b7657bc4dd2f32911915d63ebfa27d2c5bcf85fceb33b1062d063980822d8811fec21411d75066ec8f408adfb0b251f4b63dc41507991f5f150581c125e7d41e9070dd0cddab9b22c2ab55d6faac3ca9b567a0858c30f22445341c442c89c213f028453b6c5c3ba35a858c05839fcbc7bfb28e3f1e53cb877358f99b541d360c0d425807e98223f1344eb0e532e65e691cb2141638295efd5c0b39bd53957a219dacde62c3cb3a5070a3c30f086bbb1428a8d1cd8c6ec1058b91bdec0958d40056bcff41f1086758e26e2f7759b321581088135d0f86b8284a2add79d4771818990631cea0c935b7df6ec1a3ea83f9eadc3472bfdd4333f5557884d1deb8031f700ee94ab45c69b53d27fbdf65e9672689f9a1b6b83a95fc34eb7d3bdcb3ad2667d1204a38a760d30eb0df2091eb5c0ba50e8e74272dff1cefa8465f983be30ecc0bc425e62729bd6946a9ae8ce8f79dd07ad78fcf8228678020239e2c73440a3d08000d2dbf55355be14fb8bb6cab7aff61d94a32bc7fbca5ca861c83b66514beb14674c1437a16e0f5ed1d10d1e9f42a0bff64b6142996629c9dc2d812411fa05f87b2d5608091841c6f73e2ec17748c821bbaadf13bb89199d38a01bc53091ad6627324f2471fc0caed422fd79f0412d21fef9ad9630a9adbd499b9d4680a4e12549f017415ebfba6491481221a9fa810576cb1247eebb8f9748bfd0b87062a40852126acd8f81da3610150c01519e0c9a045f695cd6ddcbe683342a8df0df45d855befa336e9d5df3dd7281f6568128fd426ac6c0eea033d1383478cbe0f96ba0ae59901cc6fa576d2978ec2587e0ccfac12a1962dd3863d8113a3f0bc2a969f292ec53f31a5aaebffc18c609ce6465cdc571bb45fcbacc1258c76b76f2becc2e8f9657338e9c719e23941ab2aff1f30df11c2d9aafff78b0271a977c01941cdcfa6018722be05bab66ccc60142290a8f5cb1bc345bf2d5beb49da296d0107a00bb05d9de265ecfd78a9a05e00d50e1f50ed29b4c19ac9387366b1dae016b74f5767b2726d2ffebbad313ceca912f1e8311dd58199e2092eba8b71e54f14e4552823be36e66f2fc89bbe6230980b5f1eaa09cbae3ee703daf2fb79853f2b930f15010c77656459d1099e0bcd6127ea97b52703c5ac6fbe40e8d1d6fe010892f8f64818ac1eda346ec074a92da946662cf54d233be24cd72f5fe5d9259b1f611aecca800cd02eaadf4154b7b959f3f674f2bd61defe4bb0b169db8f43172fe2e63be27503462d55b63a4c07c5a74110c9bc32228c0b7758cd875ec5506812de06231ee93cb389d215b9974306ba87d9afe4e0178eafd45826ba750ff4bb18eede46082a650f208765812bf109412c51b8bf405c22d259a81ccb01d22aec1c2137bd486cf26b08f0df56250c8f341d2b32045f24d89f687b4ae03f13c2220bec0fcb25e6493ab198bec3324c5cfaff65a97b58062cb23ed4157de2fa06a41430d178fb08e02ec967cd3276a0b9feead0484609f36f864489cb734c4763c2188535389cf1d7973e743c3bfa3c15003a377fbfe2338df7c0c91213a3b7e1f000b13aef81a47e0a5fcbb9226ba1fb9479d868ec807df4b157a7f9a55a50b4161e0983ace2552618828ad667ae2cac87b89cb7799611b9c8a4a3d1db83548554249914068bc8f8e27bb0f04efcdbf42e8d114e8ad2ec8b19dd6286c7d797bf1410b9ac7325ed3c2ddf275d261e0613df6f94d7bc9d52c442ec624687dd4751ea23117fe266123240fa0c1dbbe0f10363a23aa022db7e243e5ad07355037b05dd0cbf683cb0843d83602671a5596b18c586037e51cf71c5c591f18d1d70477c842ebdac4a2900d748f4c2caa934469b290f73c12630bcce8560608bcfcabe77662fc4930b39fa012ec4ea7bf5d664ca10926276406cb6c07da5964700b47ee8da109138d44716e2e95955398f7631250fd2f98a1ae8d00c0e8393e98e4ec79b27147a89df2cf2cdf465894bb5a3523193c05f253652fdaf3dabfbcad5f5454de814ee3f5cd7fdb704ad9155fb42faf91a8948beb4a3c5eeca55fc3618ab7fe14f0f51ddabb45271f29e851dd8dc72cc0c94156424c6d76ad513ed6e5dd34777511211139fef9b1ea614ce39d021d750bef7dac22d1d6b0754f1f75ca52b8a6337187d140566b7c148cc7fb2069f0a8d3f242dc2fa67c768c3472e952e8ef3b57806cb3df6e231d1d3a08179d98fe66c499fc57c2dadd4a793013cabed113936931be0d013d9e849ca312eff52b0fef9eb7af5baae2c9485e6d7ca10a66ee6c4bc20c8b437c8010f6e36c5578538014818e7f3d5e7bbb97285caa0e984fc11ca86039cb9601c35150c5089504c257ab2484c8a8acfe38413dc8d54e39556acf4861f8835c9a0b9ec3cd2a4ce528e6b6deeb12f83f2228d6389c51ec339d50f4b491a795366e41f85a96c1ad235dddf696ef76d2931c62ea328635e82710eccd6e030009094afb655930f5ab66dfdd3508bc420a87680053b4c89259ceda054166513bb4606024834918b2cfe95766cc1011cb0b3996f48fb10c52681ddf48608e9191ce73a95829fa043ebbe9fdf15f65569f7f089cb8f9b79544f4a70937018fc1b316e3fbf2d552cb3c86f82f986f47a5f82428172d62bc9060271341587c80b0f3715d5daa1557c6a191867f81ad777687dbc04203867525159b57779e5bb4411c9182a5fd229380d1be39284f2d2b52dc810b11e48b15b779ff2c95526478211c9182a5fd229380d1be39284f2d2b52dc810b11e48b15b779ff2c9552647820606274872e904514fae54c392fe05eebacb317cf21864c2145ef527e8fd9732000000000000000000000000000000000000000000000000000000000000000012a96346dc56bb373fa7a47481f2a555af7e698d7d5ee85e15b52a71eca6b52600000000000000000000000000000000000000000000000000000000000000000bfa5869e48bffb049af571b016c1d02f704867d529dc476b4a8bbbc9ba20cc700000000000000000000000000000000000000000000000000000000000000000c24b61b51e788fd16e52b7b36fa8900069d3ba1a8e0e33e0596f58c00adf8ea0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000025d1658b140c13094d36e2043cffa1ecb01445407f41e08940c939e939f1df221ceb995dc741d45436421b83f487762998685ae973395e1def8695bc3a7c48ac2f58ab52bbf23d07c1cf1d3b909349863231b8c18f4f1a792b641a2201c4e3cf1bb2e7cfaa9fa5283abf35c359d354d2029d4602f854b6fe66e709f3388d7c5504f9306478f85bf10ff9e6a871fa4f51b8323f545f1f928958487d5604da95d210695f710363a2a59725a9722f1f103797d7246a80c678a331f631a47f1a72982a47c24ea8c234baa3b8c92e0f90a9dc5108b6eae3ba4a7d9adbb6a407ea4813258218cc390dd445f73f6f7a9b96736e822c17795ccb861d832411e3f82a25dc2c35757e458af546c0e40729b98c3944281c93e57aa62c956a52b0a6a16ac21716e3399f5a595d209b93e5c1162124ceac81a5a942ec6dec634f1e405e45163e294978424c55f3e4d5ee1ba358c696c9bb9b3f41c1946c9c5ff4c0abcc9737f2304a39194bed1832f1cc0dd16dcd22a4a2836210ea919c791ae94e54491aa71b1f5915894a0532f5b967dd6803305046132c1464d9e470bfa762d3936d1afa1f0a53212fa32a08f3a16eddafb21f28d3fa5c68de79f77a5ea9f799def83052e20ebc04c55bf570740e73c7c9ad206969805dc775cf7f3b96c99751584b42ae3c2d031c2cf234e97c7edf4f3f5157a667230ca90efb584ce2a8064e6a3332833e291778011ed24a0aa5f9e39385551ed11e2fbd0eabcd9e586fbdab257d3ed08314c2135bba6a4ec65f4fe10f1fc53491d6915f24d2055c50ea81443bc3fed5f305eb69043695a255579709151c3c3b30a4e54512fa86584ea67b1150eb78fda92c3bb6c632d1da59421a4c7b311a4a26772453f1ec28a665a42ce7e337388665211dac05d94326b6dc0584a56406d982b227239e658d46ace8e76d2cb0fd1f062c1e2c120013147ebac78abea1da376cd631770b64f408756ef2405b9085c97612b21293158d932736155f6571406a67ec40d37f1df1d6453a47a8ddc95cda142a5dab6e640d4f51a1c4cb6e611219e39c4634cf9f2f9fe4f489bc343bdcfc930d78692d9b0cf97a807ef94d215c9d567c777da38447659632fcf77fbbcb4c0e259d0627925082f0c358fc9ed4d87ea06ba4cfae2b0bfdc1b7826cabc10bb52e20f62739e2aaaecec94c2e6fe064f9ff0b83bfb3e5961250dd776409d516edae0059d67bafe367e3070fe0002b5a481071e6b7461fe00b8b7d0964221c484df90ed20e230a92a5f8ea3d133c6407b2ffa849454190273285ff38710c2523bb3e2ec7bbdd8c9e54275e5a7c9430c331e5d57a29d0a1fa02f3793217aa8ddb83170ab47acace7677455e8f72bd15248a16e26502d8c0da6ad7180bb8de7f66c5b02eeeb1097a82e1d589a98c740ddfac10b6423b9acf895ab81694d52f62915e462f135791804a8f1f4a305a044d62bd8429c74fa722e18b60353fdb06934a611e254c61d9caab50a63ba42107f19b2dbd903037b9deacd4945977e20ac1eef403149f7e597115482c1d37dd83af3f9feb33a2d86823363939a0aca5692d1609060b27b448e1ef414237cd8aba666d788b5cdb8ad8fb3ecc6f578aaa56838a83290de347ba95ab6dc2109e5897a330d135a458a79a73dd1474a17cb8931b4a72b608c22aaf9feb20877a2c9274eb13d96912be4d9b5743ea1cdb7ded77480a116c2f1dd0809bb923f32fab5b669653ca536dbd7a6053ba6fbb362d28a149adc424";

        bytes memory proof = vm.ffi(input_proof);
        // bytes memory proof = abi.decode(res_proof, (bytes));

        string[] memory input_instance_0 = new string[](3);
        input_instance_0[0] = "echo";
        input_instance_0[1] = "-n";
        input_instance_0[2] = "0x1d4fe12616b87b7b24900ea142a0147c94d7d19dd4617e37c84316b40faf2b44";

        bytes memory res_instance_0 = vm.ffi(input_instance_0);
        uint256 instance_0 = abi.decode(res_instance_0, (uint256));

        string[] memory input_instance_1 = new string[](3);
        input_instance_1[0] = "echo";
        input_instance_1[1] = "-n";
        input_instance_1[2] = "0x0000000000000000000000000000000000000000000000000000000000000023";

        bytes memory res_instance_1 = vm.ffi(input_instance_1);
        uint256 instance_1 = abi.decode(res_instance_1, (uint256));

        uint256[] memory instances = new uint256[](2);
        instances[0] = instance_0;
        instances[1] = instance_1;
        ci.mint(
            proof,
            instances
        );
    }

    function testFailMintUnrestricted() public {
        for (uint i=0; i < 1001; ++i) {
            ci.unrestrictedMint();
            assertEq(ci.balanceOf(address(this)), i+1);

            // output metadata into file
            string memory metadata_output = ci.tokenURI(i+1);
            vm.writeJson(metadata_output, string(abi.encodePacked("./test/metadata/", (i+1).toString())));
        }

    }

}
